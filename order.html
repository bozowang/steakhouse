function doPost(e) {
  // 設置 CORS 頭部，允許所有來源
  var headers = {
    'Access-Control-Allow-Origin': '*',
    'Access-Control-Allow-Methods': 'GET, POST, PUT, DELETE, OPTIONS',
    'Access-Control-Allow-Headers': 'Content-Type',
    'Content-Type': 'application/json'
  };

  // 處理預檢請求 (OPTIONS)
  if (e.method == 'OPTIONS') {
    return ContentService.createTextOutput(JSON.stringify({}))
      .setHeaders(headers)
      .setMimeType(ContentService.MimeType.JSON);
  }

  var lock = LockService.getScriptLock();
  lock.waitLock(30000); // 等待最多 30 秒以獲取鎖

  try {
    var sheet = SpreadsheetApp.getActiveSpreadsheet().getActiveSheet();
    
    // 如果表头为空，添加表头
    if (sheet.getLastRow() === 0) {
      sheet.appendRow([
        '時間戳', '姓名', '電話', '地址', 
        '付款方式', '訂單內容', '總金額', '備註'
      ]);
    }
    
    // 解析JSON数据
    var data = JSON.parse(e.postData.contents);
    
    // 獲取並格式化購物車商品
    var orderItems = JSON.parse(data.order);
    var orderString = orderItems.map(function(item) {
      return `${item.name} x ${item.quantity} ($${item.price * item.quantity})`;
    }).join('; ');

    var row = [
      data.timestamp, // 時間戳
      data.name,      // 姓名
      data.phone,     // 電話
      data.address,   // 地址
      data.payment,   // 付款方式
      orderString,    // 格式化後的訂單商品
      data.total,     // 總金額
      data.notes      // 備註
    ];
    
    sheet.appendRow(row);
    
    // 返回成功響應
    return ContentService
      .createTextOutput(JSON.stringify({ 
        result: "success", 
        message: "訂單已成功送出",
        orderId: Utilities.getUuid()
      }))
      .setHeaders(headers)
      .setMimeType(ContentService.MimeType.JSON);

  } catch (error) {
    // 返回失敗響應
    return ContentService
      .createTextOutput(JSON.stringify({ 
        result: "error", 
        message: error.message 
      }))
      .setHeaders(headers)
      .setMimeType(ContentService.MimeType.JSON);
  } finally {
    lock.releaseLock();
  }
}

// 用於測試的doGet函數
function doGet(e) {
  var output = ContentService.createTextOutput(JSON.stringify({
    status: "online",
    service: "Food Delivery API",
    timestamp: new Date()
  }));
  
  output.setMimeType(ContentService.MimeType.JSON);
  output.setHeaders({
    'Access-Control-Allow-Origin': '*',
    'Access-Control-Allow-Methods': 'GET, POST, PUT, DELETE, OPTIONS',
    'Access-Control-Allow-Headers': 'Content-Type'
  });
  
  return output;
}
